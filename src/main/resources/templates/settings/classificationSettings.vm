<h2>Text Classification in Jira Issue Description and Comments</h2>

#set($textClassificationConfig = $project.getTextClassificationConfiguration())

<div class="field-group">
    <label for="isClassifierUsed-toggle">Use Classifier to identify Decision Knowledge?</label>
    <aui-toggle id="isClassifierUsed-toggle"
                value="$projectKey" label="Use Classifier to Identify Decision Knowledge?"></aui-toggle>
    <div class="description">Enables or disables whether text is automatically classified
        as decision knowledge within Jira issue description and comments for this project.
    </div>
</div>

<div class="field-group" id="classifierStatus-text">
    <label>Current Classifier Status:</label>
    <div class="description">
        #if( $isClassifierTraining == "true" )
            <div class="aui-message aui-message-warning">
                <p class="title">
                    <strong>The classifier is currently training!</strong>
                </p>
            </div>
        #else
            <div class="aui-message aui-message-info">
                <p class="title">
                    <strong>The classifier is currently not training!</strong>
                </p>
            </div>
        #end
        #if( $isClassifierTrained == "true" )
            <div class="aui-message aui-message-info">
                <p class="title">
                    <strong>The classifier has already been trained!</strong>
                </p>
                <p>
                    If you have enough annotated data from your own project you might want to retrain it on
                    your project.
                    Generate a CSV file of validated decision knowledge and then select the file as the training file.
                </p>
            </div>
        #else
            <div class="aui-message aui-message-error">
                <p class="title">
                    <strong>The classifier is not yet trained!</strong>
                <p>
                    Start the training or wait for it to finish. Otherwise the classification will not work.
                </p>
            </div>
        #end
    </div>
</div>

<div class="field-group">
    <label for="useTrainedClassifier-button">Use a Trained Text Classifier</label>
    <select id="select-trained-classifier" class="select medium-long-field">
        #foreach ($classifier in $trainedClassifiers)
            <option value="$classifier"
                #if ($classifier.toString().contains($textClassificationConfig.getSelectedTrainedClassifier()))
                    selected
                #end
            >
                $classifier</option>
        #end
    </select>
    Online learning active? 
    <input type="checkbox" id="online-learning-checkbox"
    	#if ($textClassificationConfig.isOnlineLearningActivated()) 
        	checked
    	#end
    >
    <input type="button" class="aui-button" id="useTrainedClassifier-button" value="Use Classifier"/>
    <div class="description">
        Use an already trained text classifier in this project. The classifier might be updated by online training. 
        That means that manually approved parts of text are directly used for training.<br/>
    </div>
</div>

<div class="field-group">
    <label for="classifyAllIssuesInProject">Suggest Tags for Whole Project?</label>
    <input type="button" class="aui-button" id="classifyAllIssuesInProject" value="Classify Description and Comments of all Jira Issues"/>
    <div class="description">
    	Classifies the text in the description and the comments of all Jira issues for this project. 
    	This is used for the retrospective identification of decision knowledge/rationale. <br/>
    	<span class="aui-icon aui-icon-small aui-iconfont-warning">WARNING: </span> This cannot be reverted!
    </div>
    <div class="aui-progress-indicator">
        <span id="classify-whole-project-progress-bar"></span>
    </div>
</div>

<div class="field-group">
    <label for="saveTrainingFile-button">Create a Training File</label>
    <input type="button" class="aui-button" id="saveTrainingFile-button" value="Create Training File"/>
    <div class="description">Creates a training file (in csv format) of <b>manually approved</b> (i.e. human-validated) text data
        for the current project that can be used to train the classifier.
        This file is saved in the Jira home directory in data/condec-plugin/classifier. 
        You can download it from there. The file name consists of the project-key and the current data and time. 
        If you want to train the classifier with this file you need to reload this page to access the file.
    </div>
</div>

<div class="field-group">
    <label for="trainClassifier-button">Train the Text Classifier</label>
    <select id="select-training-file" class="select medium-long-field">
        #foreach ($trainingFile in $trainingFiles)
            <option value="$trainingFile"
                #if ($trainingFile.toString().contains($textClassificationConfig.getSelectedGroundTruthFile()))
                    selected
                #end
            >
                $trainingFile</option>
        #end
    </select>
    Binary:
    <select id="select-classifier-type-binary" class="select medium-field">
    	<option value="LR" selected>Logistic Regression</option>
    	<option value="SVM">Support Vector Machine</option>
    </select>
    Fine-grained:
    <select id="select-classifier-type-fine-grained" class="select medium-field">
    	<option value="LR">Logistic Regression</option>
    	<option value="SVM">Support Vector Machine</option>
    </select>
    <input type="button" class="aui-button" id="trainClassifier-button" value="Train Classifier"/>
    <div class="description">
        Trains the text classifier on the selected data file. The text classifier consists of a binary and a fine-grained classifier.<br/>
        <span class="aui-icon aui-icon-small aui-iconfont-warning">WARNING: </span> Please note that this initial
        training can be very resource expensive!
    </div>
    <div class="aui-progress-indicator">
        <span id="train-classifier-progress"></span>
    </div>
</div>

<div class="field-group">
    <label for="evaluateTextClassifier-button">Evaluate the Text Classifier using k-fold Cross-Validation</label>
  	<input type="button" class="aui-button" id="evaluateTextClassifier-button" value="Evaluate Classifier using k-fold Cross-Validation"/>
    Number of folds k: 
    <input type="number" id="number-of-folds-input" value="3" min="0" class="text short-field"/> 
    <div class="description">
        Trains and evaluates the binary and fine-grained classifiers on the selected data file and the algorithms from above via k-fold cross-validation 
        (splits the data into training and evaluation parts).<br/>
        If the classifier was trained before, the training will be restored after the evaluation finished.<br/>
        <span class="aui-icon aui-icon-small aui-iconfont-warning">WARNING: </span> Please note that this 
        evaluation can be very resource expensive!<br/>       
    </div>
</div>

<div class="field-group">
    <label for="evaluateTrainedTextClassifier-button">Evaluate the Trained Text Classifier</label>
    <input type="button" class="aui-button" id="evaluateTrainedTextClassifier-button" value="Evaluate Trained Classifier On Different Data"/>
    <div class="description">
        Evaluates the trained classifier on the selected data file above (for cross-project validation).<br/>
        <span class="aui-icon aui-icon-small aui-iconfont-warning">WARNING: </span>
        The selected data file <b>should be different from the data file that the classifier was trained on</b>.
        Otherwise, use k-fold cross-validation to train and evaluate the classifier on the same data.
    </div>
</div>

<div class="field-group">
    <label for="testClassifierWithText-input">Test the Classifier</label>
    <textarea class="textarea" id="testClassifierWithText-input" placeholder="Your text to be classified here..."></textarea>
</div>
<div class="buttons-container">
    <div class="buttons">
        <input type="button" class="aui-button" id="testClassifierWithText-button" value="Test classifier"/>
        <span class="cancel" id="testClassifierWithText-result">The result will be displayed here.</span>
    </div>
</div>

#if( $textClassificationConfig.getLastEvaluationResults() )
<div class="field-group">
    <label>Last Evaluation Results:</label>    
    <div class="aui-message aui-message-info" style="white-space: pre-line">
		$textClassificationConfig.getLastEvaluationResults()
	</div>
</div>
#end

<script>
    const isClassifierUsedToggle = document.getElementById("isClassifierUsed-toggle");
    isClassifierUsedToggle.checked = $textClassificationConfig.isActivated();
    
    isClassifierUsedToggle.addEventListener("change", function (error) {
        currentClassifierStatusInfo.style.display = this.checked ? "inherit" : "none";
        this.busy = true;
        conDecAPI.setTextClassifierEnabled(this.checked, this.value);
        this.busy = false;
    });

    const currentClassifierStatusInfo = document.getElementById("classifierStatus-text");
    currentClassifierStatusInfo.style.display = isClassifierUsedToggle.checked ? "inherit" : "none";
    
    const saveTrainingFileButton = document.getElementById("saveTrainingFile-button");
    saveTrainingFileButton.addEventListener("click", function () {
        conDecAPI.saveTrainingFile("$projectKey", saveToFile("classifierTrainingData.csv"));
    });

    const classifyAllIssuesInProjectButton = document.getElementById("classifyAllIssuesInProject");
    classifyAllIssuesInProjectButton.addEventListener("click", function () {
        if (confirm("Are you sure you want to classify all Jira issue comments and descriptions? This might take a long time if the project is big and cannot be reverted!")) {
            var animatedElementWholeProjectClassification = document.getElementById("classify-whole-project-progress-bar");
            conDecAPI.classifyWholeProject("$projectKey", animatedElementWholeProjectClassification);
        }
    });
    
    var trainedClassifierSelect = document.getElementById("select-trained-classifier");
    var useTrainedClassifier = document.getElementById("useTrainedClassifier-button");
    var onlineTrainingCheckbox = document.getElementById("online-learning-checkbox");
    useTrainedClassifier.addEventListener("click", function () {                   
    	conDecAPI.useTrainedClassifier("$projectKey", trainedClassifierSelect.value, onlineTrainingCheckbox.checked);
    });

	var trainDataSelect = document.getElementById("select-training-file");
	var binaryTypeSelect = document.getElementById("select-classifier-type-binary");
	var fineGrainedTypeSelect = document.getElementById("select-classifier-type-fine-grained");
	var animatedElement = document.getElementById("train-classifier-progress");
    const trainClassifier = document.getElementById("trainClassifier-button");
    trainClassifier.addEventListener("click", function () {
        if (confirm("Are you sure you want to retrain the classifier?")) {                        
            conDecAPI.trainClassifier("$projectKey", trainDataSelect.value, binaryTypeSelect.value, fineGrainedTypeSelect.value, animatedElement);
        }
    });
    
    const evaluateTextClassifierButton = document.getElementById("evaluateTextClassifier-button");
    evaluateTextClassifierButton.addEventListener("click", function () {
    	var numberOfFoldsInput = document.getElementById("number-of-folds-input");
    	if (confirm("Are you sure you want to evaluate the classifier using " + numberOfFoldsInput.value + "-fold cross-validation?")) {    
        	conDecAPI.evaluateTextClassifier("$projectKey", trainDataSelect.value, numberOfFoldsInput.value, 
        	binaryTypeSelect.value, fineGrainedTypeSelect.value, animatedElement, saveToFile("evaluation_results.json"));
        }
    });
    
    const evaluateTrainedTextClassifierButton = document.getElementById("evaluateTrainedTextClassifier-button");
    evaluateTrainedTextClassifierButton.addEventListener("click", function () {
        conDecAPI.evaluateTextClassifier("$projectKey", trainDataSelect.value, -1, null, null, animatedElement, saveToFile("evaluation_results.json"));
    });
    
    const testClassifierWithTextBtn = document.getElementById("testClassifierWithText-button");
    const testClassifierWithTextInput = document.getElementById("testClassifierWithText-input");
    const testClassifierWithTextResult = document.getElementById("testClassifierWithText-result");

    testClassifierWithTextBtn.addEventListener('click', () => {
       conDecAPI.classifyText(testClassifierWithTextInput.value, "$projectKey", showClassificationResult)
    });
    
    // helper functions
    showClassificationResult = function (classificationResult) {
    	document.getElementById("testClassifierWithText-result").innerText = classificationResult;
    }
    
    saveToFile = function (name) {
        return function (content) {
            let link = document.createElement("a");
            link.style.display = "none";
            link.setAttribute("href", "data:text/plain;charset=utf-8," + encodeURIComponent(content));
            link.setAttribute("download", name);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }
</script>