<h3>Configure Knowledge Sources via Resource Description Framework (RDF)</h3>
<a class="aui-expander-trigger" aria-controls="create-knowledgesource-expander">
	<span class="aui-icon aui-icon-small aui-iconfont-add">Create a Knowledge Source via RDF</span> Add
</a>
<div id="create-knowledgesource-expander" class="aui-expander-content">
	#set ($rdfId = "")
	#set ($rdfName = "")
	#set ($rdfService = "")
	#set ($rdfQuery = "")
	#set ($rdfTimeout = "30000")
	#set ($rdfConstraints = "")
   	#parse("templates/settings/decisionguidance/singleRdfSourceSettings.vm")
    <div class="field-group">
        <button class="aui-button-primary aui-button" id="create-rdf-source">Create</button>
    </div>
</div>

#foreach ($rdfSource in $decisionGuidanceConfig.getRDFKnowledgeSources())
	#set ($rdfId = $rdfSource.toString())
	#set ($rdfName = $rdfSource.getName())
	#set ($rdfService = $rdfSource.getService())
	#set ($rdfQuery = $rdfSource.getQuery())
	#set ($rdfTimeout = $rdfSource.getTimeout())
	#set ($rdfConstraints = $rdfSource.getConstraints())

<div class="field-group">
    <label>$rdfName activated?</label>    
    <aui-toggle class="activation-knowledgesource" name="$rdfName" label="$rdfName activated?"
		#if ($rdfSource.isActivated())
        checked
        #end
        ></aui-toggle>
    <a style="right: 16px; top:16px;" class="aui-expander-trigger" aria-controls="$rdfId">
   		<span class="aui-icon aui-icon-small aui-iconfont-edit-filled">Edit Knowledge Source</span>
	</a>
    <div class="description">Enables or disables the knowledge source for alternative recommendations
        for this project.
    </div>    
</div>

<div id="$rdfId" class="aui-item aui-expander-content">
	#parse("templates/settings/decisionguidance/singleRdfSourceSettings.vm")
	<div class="field-group">
	    <label for="update-rdf-source">Update</label>
	    <button id="update-rdf-source" class="aui-button update-knowledgesource" data-prefix="$rdfId"
	            name="$rdfName">
	        <span class="aui-icon aui-icon-small aui-iconfont-refresh">Updates a RDF Knowledge Source</span>
	        Update
	    </button>
	    <div class="description">Updates the RDF knowledge source.</div>
	</div>
	<div class="field-group">
	    <label for="delete-rdf-source">Delete?</label>
	    <button id="delete-rdf-source" class="aui-button-primary aui-button delete-knowledgesource" name="$rdfName">
	        <span class="aui-icon aui-icon-small aui-iconfont-trash">Deletes a RDF Knowledge Source</span> Delete
	    </button>
	    <div class="description">Deletes the knowledge source permanently from the system.</div>
	</div>
</div>
#end

<script>
	$("#create-rdf-source").click(event => {
		event.preventDefault();
		const name = $("#rdf-name-");
		const service = $("#rdf-service-");
		const query = $("#rdf-query-");
		const timeout = $("#rdf-timeout-");
		const constraints = $("#rdf-constraint-");

		var rdfSource = {
			"name": name.val(),
            "service": service.val(),
            "query": query.val(),
            "timeout": timeout.val(),
            "constraints" : constraints.val()
		}
		conDecDecisionGuidanceAPI.createRDFKnowledgeSource("$projectKey", rdfSource);
	});

    $(".update-knowledgesource").each(function() {
        $(this).click(event => {
               event.preventDefault();
               let prefix = "#" + $(this).data("prefix");
               const knowledgeSourceName = $(this).attr("name");
               const name = $("rdf-name-" + prefix);
               const service = $("rdf-service-" + prefix);
               const query = $("rdf-query-" + prefix);
               const timeout = $("rdf-timeout-" + prefix);
               const constraints = $("rdf-constraints-" + prefix);

               var rdfSource = {
                    "name": name.val(),
                    "service": service.val(),
                    "query": query.val(),
                    "timeout": timeout.val(),
                    "constraints" : constraints.val()
               }
               console.log(rdfSource);
               conDecDecisionGuidanceAPI.updateKnowledgeSource("$projectKey", knowledgeSourceName, rdfSource);
        });
    });

	$(".activation-knowledgesource").each(function() {
		$(this).change(function() {
			const knowledgeSourceName =  $(this).attr("name");
			const isActivated = $(this).prop("checked");
			conDecDecisionGuidanceAPI.setKnowledgeSourceActivated("$projectKey", knowledgeSourceName, isActivated);
		})
	});
	
	$(".delete-knowledgesource").each(function() {
		$(this).click((event) => {
			event.preventDefault();
            var confirm = window.confirm("Do you really want to delete this knowledge source?");
            if(confirm) {
                const knowledgeSourceName = $(this).attr("name");
                conDecDecisionGuidanceAPI.deleteKnowledgeSource("$projectKey", knowledgeSourceName, function() {
                	location.reload();
                });
            }
        })
	});

    const DBPEDIAPREFIX = "PREFIX dbo: <http://dbpedia.org/ontology/>\n" +
                        "PREFIX dct: <http://purl.org/dc/terms/>\n"+
                        "PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>\n" +
                        "PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\n" +
                        "PREFIX foaf: <http://xmlns.com/foaf/0.1/>\n\n";

    const FACTORYPATTERN =
           "select distinct ?subject ?url count(?links) where {\n" +
            "%variable% dct:subject ?concept.\n" +
            "?subject dct:subject ?concept.\n " +
            "?url foaf:primaryTopic ?subject.\n " +
           "FILTER(regex(?concept, 'pattern', 'i')).\n" +
           "?subject  dbo:wikiPageExternalLink ?links.\n" +
           "} GROUP BY ?subject ?url";

    const FRAMEWORKS = "select distinct ?subject ?url count(?link)   where { \n" +
                        "%variable% dbo:genre ?genre.\n" +
                        "?subject dbo:genre ?genre.\n" +
                        "?subject foaf:isPrimaryTopicOf ?url.\n" +
                        "?subject dbo:wikiPageExternalLink ?link.} GROUP BY ?subject ?url";

	$("#insert-design-patterns").click(function(event) {
        event.preventDefault();
		$("#rdf-query-").val(DBPEDIAPREFIX + FACTORYPATTERN);
	});

    $("#insert-frameworks").click(function(event) {
        event.preventDefault();
        $("#rdf-query-").val(DBPEDIAPREFIX + FRAMEWORKS);
	});

	$("#select-rdf-service").change(function() {
		var value = $(this).val();
		if (value == "DBPedia") {
			$("#rdf-service-").val("http://dbpedia.org/sparql/")
		} else {
			$("#rdf-service-").val("")
		}
	});

	$("#query-help-trigger").click(event => {
		$("#query-help").toggle();
	});
</script>